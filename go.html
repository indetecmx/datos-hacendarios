<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>INDETEC · Apertura de reporte</title>
<meta name="color-scheme" content="light dark">

<!-- Preconexiones -->
<link rel="dns-prefetch" href="https://script.google.com">
<link rel="preconnect" href="https://script.google.com" crossorigin>
<link rel="dns-prefetch" href="https://app.powerbi.com">
<link rel="preconnect" href="https://app.powerbi.com" crossorigin>

<style>
  :root {
    --bg:#0b0d12; --fg:#eaeef8; --muted:#9aa3b5; --accent:#2f6fed;
  }
  @media (prefers-color-scheme:light){
    :root { --bg:#f7f9fc; --fg:#0b0d12; --muted:#5b6476; --accent:#2f6fed; }
  }
  *{box-sizing:border-box}
  body{
    margin:0; padding:40px; background:var(--bg); color:var(--fg);
    font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    text-align:center;
  }
  h1{font-size:1.25rem;margin:0 0 6px}
  .meta{color:var(--muted);font-size:.95rem}
  .loader{
    border:4px solid rgba(0,0,0,.15);
    border-top:4px solid var(--accent);
    border-radius:50%;
    width:40px;height:40px;
    margin:18px auto;
    animation:spin 1s linear infinite;
  }
  @keyframes spin{to{transform:rotate(360deg)}}
</style>
</head>

<body>
  <h1 id="t">Abriendo reporte…</h1>
  <p id="m" class="meta">Preparando redirección segura</p>
  <div class="loader" role="progressbar" aria-label="Cargando"></div>

<script>
/* ========= 1) TU Apps Script ========= */
// ⚠️ Reemplaza este ID por el de tu último despliegue (Deploy → New deployment → Web app)
const TRACK_URL = "https://script.google.com/macros/s/AKfycbzHrQSlW2c-hV2myQ3er9WDlMm1DGDJ32YPBQeapF5n4HqS0A5X58jGnXyrttoOv4x8Yg/exec";

/* ========= 2) Catálogo de nombres ========= */
const NAMES = {
  pe_cap_2015_2024:'Presupuestos de egresos estatales a nivel capítulo para el periodo 2015 a 2024',
  pe_2000_2023:'Presupuesto de egresos 2000 a 2023',
  pe_entidades:'Reporte del presupuesto de egresos por entidad federativa',
  efipem_1989_2024:'Estadísticas de finanzas públicas municipales y estatales. EFIPEM 1989-2024',
  cuentas_capitales:'Cuentas públicas de los municipios capitales',
  leyes_2019_2025:'Estadísticas de Leyes de Ingresos 2019-2025',
  leyes_imp_2019_2025:'Estadísticas de Leyes de Ingresos Impuestos 2019-2025',
  efipem_2023:'Estadísticas de finanzas públicas municipales. EFIPEM 2023',
  efipem_1989_2023:'Estadísticas de finanzas públicas municipales. EFIPEM 1989-2023',
  deuda_municipal:'Reporte de deuda pública municipal',
  balance_cp_2014_2024:'Balance de Cuentas Públicas (2014-2024)',
  balance_proj_2025_2030:'Balance de Ingresos y Egresos Proyectados 2025-2030',
  balance_ldf_2017_2024:'Balance de resultado de ingresos y egresos LDF 2017-2024',
  eai_ldf:'Estado Analítico de los Ingresos LDF',
  mapas_personal:'Mapas de personal ocupado por actividad económica',
  predial_potencial:'Impuesto predial potencial',
  impuestos_potenciales:'Impuestos potenciales',
  pronosticos:'Pronósticos',
  mapas:'Mapas',
  indicadores:'Indicadores',
  panorama_hacienda:'Panorama de la Hacienda Pública',
  ambientales:'Ambientales',
  deuda:'Deuda',
  municipal:'Municipal',
  derechos_agua:'Derechos de agua potable',
  censos_eco24:'Censos Económicos 2024',
  // Mapas por estado
  mapas_AGS:'Mapas · AGS', mapas_BC:'Mapas · BC', mapas_BCS:'Mapas · BCS', mapas_CAMP:'Mapas · CAMP',
  mapas_CHIS:'Mapas · CHIS', mapas_CHIH:'Mapas · CHIH', mapas_COAH:'Mapas · COAH', mapas_COL:'Mapas · COL',
  mapas_CDMX:'Mapas · CDMX', mapas_DGO:'Mapas · DGO', mapas_GTO:'Mapas · GTO', mapas_GRO:'Mapas · GRO',
  mapas_HGO:'Mapas · HGO', mapas_JAL:'Mapas · JAL', mapas_EDOMEX:'Mapas · EDOMEX', mapas_MICH:'Mapas · MICH',
  mapas_MOR:'Mapas · MOR', mapas_NAY:'Mapas · NAY', mapas_NL:'Mapas · NL', mapas_OAX:'Mapas · OAX',
  mapas_SLP:'Mapas · SLP', mapas_PUE:'Mapas · PUE', mapas_QRO:'Mapas · QRO', mapas_QROO:'Mapas · QROO',
  mapas_SIN:'Mapas · SIN', mapas_SON:'Mapas · SON', mapas_TAB:'Mapas · TAB', mapas_TAMPS:'Mapas · TAMPS',
  mapas_TLAX:'Mapas · TLAX', mapas_VER:'Mapas · VER', mapas_YUC:'Mapas · YUC', mapas_ZAC:'Mapas · ZAC'
};

/* ========= 3) Lógica ========= */
(async function(){
  const qs = new URLSearchParams(location.search);
  const id = (qs.get("id") || qs.get("r") || "").trim();
  const src = (qs.get("src") || "go.html").trim();

  const t = document.getElementById("t");
  const m = document.getElementById("m");

  if(!id){
    t.textContent = "ID faltante o inválido";
    m.textContent = "Ejemplo: ?id=mapas_JAL";
    return;
  }

  const name = NAMES[id] || id;
  t.textContent = "Abriendo reporte";
  m.textContent = name;

  // payload con metadatos del cliente
  const payload = {
    r: id,
    name,
    ts: Date.now(),
    userAgent: navigator.userAgent,
    source: src
  };

  let ok = false;

  // 1) Intentar sendBeacon
  try{
    if(navigator.sendBeacon){
      const blob = new Blob([JSON.stringify(payload)], { type:"application/json" });
      ok = navigator.sendBeacon(TRACK_URL, blob);
    }
  }catch{}

  // 2) Fallback fetch POST
  if(!ok){
    try{
      await fetch(TRACK_URL, {
        method: "POST",
        body: JSON.stringify(payload),
        keepalive: true,
        mode: "no-cors"
      });
      ok = true;
    }catch{}
  }

  // 3) Último recurso: GET “silencioso” (nunca abre Apps Script)
  if(!ok){
    try{
      const u = `${TRACK_URL}?id=${encodeURIComponent(id)}&src=${encodeURIComponent("go_fallback")}`;
      fetch(u, { method: "GET", mode: "no-cors", keepalive: true });
    }catch{}
  }

  // Redirección al PBI después de registrar
  const base = "https://app.powerbi.com/view?r=";
  const entry = Object.entries(NAMES).find(([key]) => key === id);
  const dest = TARGETS?.[id] || ""; // si defines TARGETS, úsalo, o concatenar manualmente
  setTimeout(() => location.replace(dest), 120);
})();
</script>
</body>
</html>
