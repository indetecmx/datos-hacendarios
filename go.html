<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Abriendo reporte · Datos Hacendarios</title>
<meta name="color-scheme" content="light dark">
<link rel="preconnect" href="https://script.google.com" crossorigin>
<style>
  :root{--bg:#0b0d12;--fg:#eaeef8;--muted:#98a0b3;--card:#121621;--accent:#6aa7ff}
  body{margin:0;background:var(--bg);color:var(--fg);font:16px system-ui,-apple-system,Segoe UI,Roboto,sans-serif;min-height:100svh;display:grid;place-items:center}
  .card{width:min(560px,90vw);background:var(--card);border:1px solid #22283a;border-radius:16px;padding:28px 24px;box-shadow:0 10px 30px rgba(0,0,0,.35);text-align:center}
  .h1{font-size:22px;font-weight:700;margin:8px 0 6px}
  .p{color:var(--muted);margin:0 0 18px}
  .ok{color:#6fe391;font-weight:600;margin-top:12px}
  .row{display:flex;gap:12px;justify-content:center;margin-top:14px;flex-wrap:wrap}
  button{border:0;border-radius:10px;padding:12px 18px;cursor:pointer;font-weight:600}
  .primary{background:var(--accent);color:#001a3d}
  .ghost{background:#1a2235;color:var(--fg);border:1px solid #223050}
  .spin{display:inline-block;width:26px;height:26px;border-radius:50%;
        border:3px solid rgba(255,255,255,.15);border-top-color:var(--accent);
        animation:rot 1s linear infinite;margin:10px auto}
  @keyframes rot{to{transform:rotate(360deg)}}
  .logos{display:flex;gap:16px;align-items:center;justify-content:center;opacity:.95}
  .logos img{height:42px;object-fit:contain}
</style>
</head>
<body>
  <div class="card">
    <div class="logos">
      <img src="https://raw.githubusercontent.com/TU-usuario/TU-repo/main/assets/datos_hacendarios.png" alt="Datos Hacendarios">
      <img src="https://raw.githubusercontent.com/TU-usuario/TU-repo/main/assets/indetec.png" alt="INDETEC">
    </div>
    <div class="h1" id="title">Abriendo reporte</div>
    <p class="p" id="subtitle">Conexión segura verificada.</p>
    <div class="spin" id="spinner"></div>
    <div class="ok" id="status">Enlace verificado correctamente.</div>
    <div class="row">
      <button class="primary" id="openBtn">Abrir ahora</button>
      <button class="ghost" id="copyBtn">Copiar enlace estable</button>
    </div>
  </div>

<script>
(function(){
  // === Config ===
  const GAS_ENDPOINT = "https://script.google.com/macros/s/TU_DEPLOY_ID/exec"; // doPost
  // Mapa de IDs 'r' -> URL final de Power BI
  const ROUTES = {
    derechos_agua_hist: "https://app.powerbi.com/view?r=XXXX",
    derechos_agua_est:  "https://app.powerbi.com/view?r=YYYY",
    derechos_agua_mun:  "https://app.powerbi.com/view?r=ZZZZ",
    // ... añade todos tus IDs aquí
  };

  // === Utilidades ===
  const qs = new URLSearchParams(location.search);
  const r    = qs.get("r") || "";
  const name = qs.get("name") || "Reporte";
  const src  = qs.get("src")  || "direct";
  const dest = ROUTES[r];

  // Render
  document.getElementById("title").textContent = name;
  document.getElementById("subtitle").textContent = dest
      ? "Conexión segura a Power BI verificada."
      : "No se encontró el destino para este enlace.";

  // Log de vista (no bloqueante)
  try {
    fetch(GAS_ENDPOINT, {
      method: "POST",
      mode: "no-cors",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({
        r, name, src,
        source: document.referrer || "",
        userAgent: navigator.userAgent,
        ts: Date.now()
      })
    });
  } catch(e){ /* silencio elegante */ }

  // Acciones
  const open = () => {
    if(!dest){ alert("Enlace no configurado (r desconocido)."); return; }
    location.href = dest;
  };
  document.getElementById("openBtn").onclick = open;

  document.getElementById("copyBtn").onclick = async () => {
    const stable = location.origin + location.pathname + "?name=" +
      encodeURIComponent(name) + "&src=" + encodeURIComponent(src) + "&r=" + encodeURIComponent(r);
    try{
      await navigator.clipboard.writeText(stable);
      document.getElementById("status").textContent = "Enlace copiado al portapapeles.";
    }catch(_){
      prompt("Copia el enlace estable:", stable);
    }
  };

  // Auto-open opcional tras 1.2s (comenta si no lo quieres)
  setTimeout(() => { if(dest) open(); }, 1200);
})();
</script>
</body>
</html>


